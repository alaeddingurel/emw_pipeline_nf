This repo is a pipeline that takes an HTML/JSON formatted news articles and do several NLP tasks on them. 

An input file will cross by all/some the components of the pipeline. The output of each component will be written directly to a copy of the given file.
where the output of each component is as follows, 

* Document classifier -> 'doc_label'=0/1 
* Violent_classifer -> 'is_violent'=0/1
* Sentence_classifier will tokenize the sentences and get their labels for 4 different classifers-> 
    * 'sentences'=[]
    * 'sentence_labels'=[]
    * 'sentence_tokens'=[[]]
    * 'Trigger_Semantic_label'=[] 
    * 'participant_semantic'=[] 
    * 'organizer_semantic'=[] 

* Token_classifers -> 'token_labels'=[[]]

* report script (`bin/out_to_csv.py`) will create a detailed report on sentence base and merge coreferensed setnences using `[NS]` token.

An example output row can be found at the end of the page.

This Repo contains two branchs ,
# [all_components](https://github.com/emerging-welfare/emw_pipeline_nf/tree/all_components)

This brach will run the pipeline as it illustrated in the flowchart. Where no filtering will be applied. 

Flowchart,

![Test](https://media.giphy.com/media/lrtUmgopBzTYIB3tA8/giphy.gif)


# [hpc](https://github.com/emerging-welfare/emw_pipeline_nf/tree/hpc) (to be renamed as cascaded_version)
This brach will run the pipeline as it illustrated in the flowchart. Where filtering will be applied and only postive sentences of a postive document will be passed.

![Test](https://media.giphy.com/media/gIOFwSETRmtKI29yIj/giphy.gif)


## Prerequisite
* Java 7 or 8
* Python3


## Installation
`install.sh` will install/download the following models in $HOME/.pytorch_pretrained_bert folder

* Nextflow
* Python requirments libraries (requirement.txt)
* OsmanMutlu/pytorch-pretrained-BERT
* Document Models (Protest classifier (BERT) - Violent Classifier (SVM) ) 
* Sentence Model (Protest classifier (BERT) - Participant Semantic Categorization (BERT), Trigger Semantic Categorization (BERT), and Organizer Semantic Categorization (BERT)- Coreference Model (ALBERT))
* Token Model(Token Classifier)
```
cd emw_pipeline_nf
source install.sh
```

## Parameters
It can be modified in `nextflow.conf` file 

## Run 
Set your parameters in `nextflow.conf` first. 
`start.sh` script will start the FLASK API of classifiers then will format the paramters that are in `nextflow.conf` to a JSON file and run nextflow. After nextflow is done reporting part will be started.

```
source start.sh
```


### Output example, 

|     | url                                                      | doc_text                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |   doc_label |   doc_is_violent | sentence_number   | sentence_text                                                                                                                                                                                                                                                                                                                                                                                       | sentence_label   | publish_date             | triggers                    | places        | times            | participants        | organizers   | targets   | facilities          | trigger_semantic     | participant_semantic         | organizer_semantic           |
|----:|:---------------------------------------------------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------:|-----------------:|:------------------|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:-----------------|:-------------------------|:----------------------------|:--------------|:-----------------|:--------------------|:-------------|:----------|:--------------------|:---------------------|:-----------------------------|:-----------------------------|
|   0 | http://en.people.cn/90001/90778/90858/90863/6309613.html | The economic loss from the cyclone Sidr which hit the country's southern and southwestern coastal areas on Nov. 15 night, is estimated at 2.31 billion U.S. dollars, the Financial Express reported Monday.....                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |           0 |                0 | 0                 | The economic loss from the cyclone Sidr which hit the country's southern and southwestern coastal areas on Nov....                                                                                                                                                                                         | 0                | 15:29, November 26, 2007 | nan                         | nan           | on Nov. 15 night | nan                 | nan          | nan       | nan                 | ind_act              | profesyonel                  | Labor_Union                  |
|   1 | http://en.people.cn/90001/90778/90858/90863/6309613.html | nan                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |           0 |                0 | 1                 | A preliminary estimate puts the total loss from the cyclone at 2.31 billion U.S. dollars, ....                                                                                                                                                                                                                                             | 0                | 15:29, November 26, 2007 | nan                         | nan           | nan              | nan                 | nan          | nan       | nan                 | demonst              | profesyonel                  | Labor_Union                  |
|   2 | http://en.people.cn/90001/90778/90858/90863/6309613.html | nan                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |           0 |                0 | 2                 | Principal Staff Officer (PSO) at the Armed Forces Division Lt Gen Masud Uddin Chowdhury told reporters Sunday ....                                                                                                                                                                                                          | 0                | 15:29, November 26, 2007 | nan                         | nan           | nan              | nan                 | nan          | nan       | nan                 | demonst              | profesyonel                  | Labor_Union                  |
|   3 | http://en.people.cn/90001/90778/90858/90863/6309613.html | nan                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |           0 |                0 | 3                 | The meeting urged all to operate relief activities in coordination with the local administration ...                                                                                                                                                                                                                                                       | 0                | 15:29, November 26, 2007 | nan                         | nan           | nan              | nan                 | nan          | nan       | nan                 | demonst              | profesyonel                  | Labor_Union                  |
|   4 | http://en.people.cn/90001/90778/90858/90863/6309613.html | nan                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |           0 |                0 | 4                 | The cyclone Sidr, one of the fiercest cyclones that hit the country in the last 131 years, affected 30 out of the country's 64 districts, leaving at least 3,199 dead, more than 1,000 missing and some 34,500 injured.                                                                                                                                                                             | 0                | 15:29, November 26, 2007 | nan                         | nan           | nan              | nan                 | nan          | nan       | nan                 | ind_act              | profesyonel                  | Labor_Union                  |
| 200 | http://en.people.cn/90001/90776/90883/6382301.html       | The website " www.anti-CNN.com " reflects public condemnation of some Western media's "distorted" reports of the riots in Lhasa .... |           1 |                0 | 0                 | The website " www.anti-CNN.com " reflects public condemnation of some Western media's "distorted" reports of the riots in Lhasa...                                                                                                                                                          | 1                | 08:18, March 28, 2008    | riots                       | Lhasa & Tibet | nan              | nan                 | nan          | nan       | nan                 | ind_act              | profesyonel                  | Labor_Union                  |
| 201 | http://en.people.cn/90001/90776/90883/6382301.html       | nan                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |           1 |                0 | 1                 | "It is purely spontaneous condemnation and criticism by the Chinese people toward some Western...                                                                                                                                                                                        | 0                | 08:18, March 28, 2008    | nan                         | nan           | nan              | nan                 | nan          | nan       | nan                 | ind_act              | profesyonel                  | Labor_Union                  |
| 202 | http://en.people.cn/90001/90776/90883/6382301.html       | nan                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |           1 |                0 | 2                 | Qin was responding to a question concerning "www.anti-CNN.com", which its creators say they launched to ....                                                                                                                                                                                                                         | 0                | 08:18, March 28, 2008    | nan                         | Tibet         | nan              | nan                 | nan          | nan       | nan                 | ind_act              | profesyonel                  | Labor_Union                  |
| 203 | http://en.people.cn/90001/90776/90883/6382301.html       | nan                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |           1 |                0 | 3                 | "What the Tibetan incident leaves us is a mirror which tells us the true colours of...                                                                                                                                                                                                                                                                 | 0                | 08:18, March 28, 2008    | nan                         | nan           | nan              | nan                 | nan          | nan       | nan                 | ind_act              | profesyonel                  | Labor_Union                  |
| 204 | http://en.people.cn/90001/90776/90883/6382301.html       | nan                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |           1 |                0 | 7                 | The Information Office of China's State Council has arranged a three-day trip for an international delegation...                         | 0                | 08:18, March 28, 2008    | nan                         | nan           | nan              | nan                 | nan          | nan       | nan                 | ind_act              | profesyonel                  | Labor_Union                  |
| 205 | http://en.people.cn/90001/90776/90883/6382301.html       | nan                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |           1 |                0 | 8                 | Lhasa is returning to normal after the March 14 unrest that was believed to be organized, premeditated and masterminded by the Dalai Lama group.                                                                                                                                                                                                                                                    | 1                | 08:18, March 28, 2008    | unrest                      | nan           | March 14         | nan                 | Dalai        | Lama      | nan                 | ind_act              | profesyonel                  | Labor_Union                  |
| 206 | http://en.people.cn/90001/90776/90883/6382301.html       | nan                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |           1 |                0 | 9                 | The unrest, involving beating, smashing, ransacking and arson, led to the deaths of at least 18 civilians and one police officer.                                                                                                                                                                                                                                                                   | 1                | 08:18, March 28, 2008    | unrest & ransacking & arson | nan           | nan              | nan                 | nan          | nan       | nan                 | ind_act              | profesyonel                  | Labor_Union                  |
| 207 | http://en.people.cn/90001/90776/90883/6382301.html       | nan                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |           1 |                0 | [6, 10]           | Tens of thousands of people from China and abroad have been angered by biased and dishonest ... [NS] It also left 382 civilians and 241 police officers injured, businesses looted,... | ['1', '1']       | 08:18, March 28, 2008    | riots [NS] torched          | Tibet [NS]    | [NS]             | [NS]                | [NS]         | [NS]      | [NS]                | ind_act [NS] ind_act | profesyonel [NS] profesyonel | Labor_Union [NS] Labor_Union |
| 208 | http://en.people.cn/90001/90776/90883/6382301.html       | nan                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |           1 |                0 | [4, 5]            | It includes a photograph on the CNN news network website .... [NS] The original picture uploaded by Chinese Internet users...                                                                                                                                                               | ['0', '1']       | 08:18, March 28, 2008    | running [NS] stones         | [NS]          | [NS]             | people [NS] rioters | [NS]         | [NS]      | truck [NS] at truck | ind_act [NS] demonst | profesyonel [NS] profesyonel | Labor_Union [NS] Labor_Union |
